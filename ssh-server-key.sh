#!/bin/bash

# ==========================================================================
#  ssh-server-key - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–æ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –∏ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ SSH –∫–ª—é—á–æ–≤–µ
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-05-22
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∏–∑–≤—ä—Ä—à–≤–∞:
#    ‚úî –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ SSH –∫–ª—é—á–æ–≤–µ (–∞–∫–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç –∏–ª–∏ –ø—Ä–∏ –∑–∞—è–≤–µ–Ω–æ –ø—Ä–µ–∑–∞–ø–∏—Å–≤–∞–Ω–µ)
#    ‚úî –ö–∞—á–≤–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω–∏—è –∫–ª—é—á –Ω–∞ –æ—Ç–¥–∞–ª–µ—á–µ–Ω —Å—ä—Ä–≤—ä—Ä —á—Ä–µ–∑ ssh-copy-id
#    ‚úî –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞ –±—ä—Ä–∑–∞ SSH –≤—Ä—ä–∑–∫–∞ –≤ ~/.ssh/config
#
#  –ï—Ç–∞–ø–∏:
#    1. –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ IP –∞–¥—Ä–µ—Å, –ø—Å–µ–≤–¥–æ–Ω–∏–º –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –≤—Ä—ä–∑–∫–∞
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –∫–ª—é—á–æ–≤–µ –∏ –æ–ø—Ü–∏—è –∑–∞ –ø—Ä–µ–∑–∞–ø–∏—Å
#    3. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ (–∞–∫–æ –µ –∏–∑–±—Ä–∞–Ω–æ)
#    4. –ö–∞—á–≤–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω–∏—è –∫–ª—é—á –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
#    5. –ó–∞–ø–∏—Å –≤ SSH config –∑–∞ –±—ä—Ä–∑–∞ –≤—Ä—ä–∑–∫–∞
# ==========================================================================
#
# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: ssh-server-key.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–æ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –∏ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ SSH –∫–ª—é—á –∫—ä–º –æ—Ç–¥–∞–ª–µ—á–µ–Ω —Å—ä—Ä–≤—ä—Ä."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "ssh-server-key –≤–µ—Ä—Å–∏—è 1.0 (22 –º–∞–π 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === –í–ò–ó–£–ê–õ–ï–ù –•–ï–î–ï–† ========================================================
echo ""
echo -e "\e[32m=============================================="
echo -e "   –°–™–ó–î–ê–í–ê–ù–ï –ò –ö–ê–ß–í–ê–ù–ï –ù–ê SSH –ö–õ–Æ–ß–û–í–ï"
echo -e "==============================================\e[0m"
echo ""
echo ""

###############################################################################
echo "[1] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –í–ê–õ–ò–î–ï–ù IPv4 –ê–î–†–ï–°..."
echo "-------------------------------------------------------------------------"

# –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–µ–Ω IPv4 –∞–¥—Ä–µ—Å
is_valid_ip() {
  local ip_input=$1
  [[ $ip_input =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || return 1
  IFS='.' read -r -a octets <<< "$ip_input"
  for octet in "${octets[@]}"; do
    ((octet >= 0 && octet <= 255)) || return 1
  done
  return 0
}

while true; do
  read -rp "–í—ä–≤–µ–¥–µ—Ç–µ IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): " host_ip

  if [[ -z "$host_ip" ]]; then
    echo "‚ùå –í—ä–≤–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ IP –∞–¥—Ä–µ—Å –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥)."
    continue
  fi

  if [[ "$host_ip" == "q" ]]; then
    echo "‚õî –ü—Ä–µ–∫—ä—Å–≤–∞–Ω–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  fi

  if ! is_valid_ip "$host_ip"; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    continue
  fi

  echo "‚úÖ –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP –∞–¥—Ä–µ—Å '$host_ip' –µ –≤–∞–ª–∏–¥–µ–Ω."  # <- –¢—É–∫
  break
done

echo ""
echo ""


###############################################################################
echo "[2] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –°–™–†–í–™–†–ï–ù –ü–°–ï–í–î–û–ù–ò–ú..."
echo "-------------------------------------------------------------------------"

# –î–æ–ø—É—Å—Ç–∏–º–∏ —Å–∏–º–≤–æ–ª–∏: –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, —Ç–∏—Ä–µ –∏ –¥–æ–ª–Ω–∞ —á–µ—Ä—Ç–∞. –î—ä–ª–∂–∏–Ω–∞: 3 –¥–æ 15 –∑–Ω–∞–∫–∞.
while true; do
  read -rp "–í—ä–≤–µ–¥–µ—Ç–µ —Å—ä—Ä–≤—ä—Ä–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º (–±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_', 3-20 —Å–∏–º–≤–æ–ª–∞): " server_alias
  if [[ "$server_alias" =~ ^[a-zA-Z0-9_-]{3,20}$ ]]; then
    break
  else
    echo "–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º. –ú–æ–ª—è, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —Å–∞–º–æ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, —Ç–∏—Ä–µ –∏ –¥–æ–ª–Ω–∞ —á–µ—Ä—Ç–∞, –º–µ–∂–¥—É 3 –∏ 20 —Å–∏–º–≤–æ–ª–∞."
  fi
done
echo "‚úÖ –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç –ø—Å–µ–≤–¥–æ–Ω–∏–º '$server_alias' –µ –≤–∞–ª–∏–¥–µ–Ω."

echo ""
echo ""


###############################################################################
echo "[3] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –ü–°–ï–í–î–û–ù–ò–ú –ó–ê –ë–™–†–ó–ê SSH –í–†–™–ó–ö–ê..."
echo "-------------------------------------------------------------------------"

# –†–µ–∑–µ—Ä–≤–∏—Ä–∞–Ω–∏ –ø—Å–µ–≤–¥–æ–Ω–∏–º–∏, –∫–æ–∏—Ç–æ –Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç
reserved_aliases=("root" "default" "admin")

# –§—É–Ω–∫—Ü–∏—è –∑–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ø—Å–µ–≤–¥–æ–Ω–∏–º
validate_alias() {
  local alias="$1"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –¥—ä–ª–∂–∏–Ω–∞ –∏ –¥–æ–ø—É—Å—Ç–∏–º–∏ —Å–∏–º–≤–æ–ª–∏
  if ! [[ "$alias" =~ ^[a-zA-Z0-9_-]{2,10}$ ]]; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º. –î–æ–ø—É—Å–∫–∞—Ç —Å–µ —Å–∞–º–æ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_', –º–µ–∂–¥—É 2 –∏ 10 —Å–∏–º–≤–æ–ª–∞."
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –µ –≤ —Å–ø–∏—Å—ä–∫–∞ —Å—ä—Å –∑–∞–±—Ä–∞–Ω–µ–Ω–∏ –∏–º–µ–Ω–∞
  for reserved in "${reserved_aliases[@]}"; do
    if [[ "$alias" == "$reserved" ]]; then
      echo "‚ùå –ü—Å–µ–≤–¥–æ–Ω–∏–º—ä—Ç '$alias' –µ –∑–∞–ø–∞–∑–µ–Ω –∏ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω."
      return 2
    fi
  done

  return 0
}

# –ß–µ—Ç–µ–Ω–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
while true; do
  read -rp "–í—ä–≤–µ–¥–µ—Ç–µ –ø—Å–µ–≤–¥–æ–Ω–∏–º –∑–∞ –±—ä—Ä–∑–∞ SSH –≤—Ä—ä–∑–∫–∞ (–Ω–∞–ø—Ä. myserver –∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): " quick_connect

  if [[ -z "$quick_connect" ]]; then
    echo "‚ùå –í—ä–≤–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Å–µ–≤–¥–æ–Ω–∏–º –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    continue
  fi

  if [[ "$quick_connect" == "q" ]]; then
    echo "‚õî –ü—Ä–µ–∫—ä—Å–≤–∞–Ω–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  fi

  if validate_alias "$quick_connect"; then
    break
  fi

  # –§—É–Ω–∫—Ü–∏—è—Ç–∞ –≤–µ—á–µ –µ –∏–∑–ø–∏—Å–∞–ª–∞ –≥—Ä–µ—à–∫–∞, –Ω–µ –ø–æ–≤—Ç–∞—Ä—è–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ —Ç—É–∫
done

echo "‚úÖ –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç –ø—Å–µ–≤–¥–æ–Ω–∏–º '$quick_connect' –µ –≤–∞–ª–∏–¥–µ–Ω."
echo ""
echo ""


###############################################################################
echo "[4] –ü–†–û–í–ï–†–ö–ê –ù–ê SSH –ü–°–ï–í–î–û–ù–ò–ú–ê..."
echo "-------------------------------------------------------------------------"

overwrite_config="false"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ø—Å–µ–≤–¥–æ–Ω–∏–º—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –≤ SSH config —Ñ–∞–π–ª–∞
if grep -qE "^Host $quick_connect\$" "$config_file" 2>/dev/null; then
  while true; do
    read -rp "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –∑–∞ '$quick_connect' –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞. –î–∞ –±—ä–¥–µ –ª–∏ –ø—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∞? [y/N/q]: " confirm
    case "$confirm" in
      [yY]) 
        echo "‚úÖ –ó–∞–ø–∏—Å—ä—Ç —â–µ –±—ä–¥–µ –æ–±–Ω–æ–≤–µ–Ω."
        overwrite_config="true"
        break
        ;;
      [nN]|"") 
        echo "‚è≠Ô∏è  –ü—Ä–µ—Å–∫–∞—á–∞–Ω–µ –Ω–∞ –∑–∞–ø–∏—Å –≤ config —Ñ–∞–π–ª–∞."
        break
        ;;
      [qQ]) 
        echo "‚õî –ü—Ä–µ–∫—Ä–∞—Ç–µ–Ω–æ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
        exit 0
        ;;
      *) 
        echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
        ;;
    esac
  done
fi

echo "‚úÖ –©–µ –±—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º '$quick_connect'."
echo ""
echo ""


###############################################################################
echo "[5] –ü–†–û–í–ï–†–ö–ê –ó–ê –ù–ê–õ–ò–ß–ù–ò SSH –ö–õ–Æ–ß–û–í–ï..."
echo "-------------------------------------------------------------------------"

# –ü—ä—Ç –¥–æ SSH –∫–ª—é—á–∞ ‚Äì –Ω–∞ –±–∞–∑–∞ —Å—ä—Ä–≤—ä—Ä–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º
key_path="$HOME/.ssh/${server_alias}"

overwrite_keys=false

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–ª—é—á–æ–≤–µ—Ç–µ –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç
if [[ -f "$key_path" || -f "$key_path.pub" ]]; then
  echo "üîë –û—Ç–∫—Ä–∏—Ç–∏ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ SSH –∫–ª—é—á–æ–≤–µ:"
  echo " - $key_path"
  echo " - $key_path.pub"
  echo ""
  while true; do
    read -rp "–ñ–µ–ª–∞–µ—Ç–µ –ª–∏ –¥–∞ –ø—Ä–µ–∑–∞–ø–∏—à–µ—Ç–µ –∫–ª—é—á–æ–≤–µ—Ç–µ? [y/N/q]: " overwrite
    case "$overwrite" in
      [yY])
        overwrite_keys=true
        echo "‚úÖ –ö–ª—é—á–æ–≤–µ—Ç–µ —â–µ –±—ä–¥–∞—Ç –ø—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏ –Ω–∞ –ø–æ-–∫—ä—Å–µ–Ω –µ—Ç–∞–ø."
        break
        ;;
      [nN]|"")
        echo "‚úîÔ∏è –°—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—Ç–µ –∫–ª—é—á–æ–≤–µ —â–µ –±—ä–¥–∞—Ç –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏."
        break
        ;;
      [qQ])
        echo "‚õî –ü—Ä–µ–∫—Ä–∞—Ç–µ–Ω–æ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
        exit 0
        ;;
      *) echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ." ;;
    esac
  done
else
  echo "‚ÑπÔ∏è –ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ SSH –∫–ª—é—á–æ–≤–µ –∑–∞ '$server_alias'. –©–µ –±—ä–¥–∞—Ç —Å—ä–∑–¥–∞–¥–µ–Ω–∏ –ø–æ-–∫—ä—Å–Ω–æ."
  overwrite_keys=true
fi

echo ""
echo ""


###############################################################################
echo "[6] –ü–†–û–í–ï–†–ö–ê –ù–ê –°–™–ë–†–ê–ù–ò–¢–ï –î–ê–ù–ù–ò..."
echo "-------------------------------------------------------------------------"

echo ""
echo "  üñß IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞              : $host_ip"
echo "  üè∑Ô∏è –°—ä—Ä–≤—ä—Ä–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º               : $server_alias"
echo "  üè∑Ô∏è –ü—Å–µ–≤–¥–æ–Ω–∏–º –∑–∞ –±—ä—Ä–∑–∞ SSH –≤—Ä—ä–∑–∫–∞    : $quick_connect"
echo "  üîê –ö–ª—é—á–æ–≤–µ –∑–∞ SSH –¥–æ—Å—Ç—ä–ø           : $HOME/.ssh/${server_alias}"
echo "  ------------------------------------"
if [[ "$overwrite_keys" == true ]]; then
  echo "  ‚ö†Ô∏è  –ö–ª—é—á–æ–≤–µ—Ç–µ —â–µ –±—ä–¥–∞—Ç –ø—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏."
else
  echo "  ‚úÖ –©–µ –±—ä–¥–∞—Ç –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—Ç–µ –∫–ª—é—á–æ–≤–µ."
fi
echo ""

# –í—ä–∑–º–æ–∂–Ω–æ—Å—Ç –∑–∞ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –∏–∑—Ö–æ–¥
while true; do
  read -rp "–ñ–µ–ª–∞–µ—Ç–µ –ª–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞? [Enter = –ø—Ä–æ–¥—ä–ª–∂–∏ / q = –∏–∑—Ö–æ–¥]: " next_step
  case "$next_step" in
    [qQ])
      echo "‚õî –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ –∏–ª–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏."
      exit 0
      ;;
    "")
      echo "‚úÖ –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ—Ç–æ..."
      break
      ;;
    *)
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ Enter –∑–∞ –ø—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ –∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥."
      ;;
  esac
done

echo ""
echo ""


###############################################################################
echo "[7] –°–™–ó–î–ê–í–ê–ù–ï –ù–ê SSH –ö–õ–Æ–ß–û–í–ï (–∞–∫–æ –µ –∏–∑–±—Ä–∞–Ω–æ)..."
echo "-------------------------------------------------------------------------"

key_path="$HOME/.ssh/${server_alias}"

if [[ "$overwrite_keys" == true ]]; then
  echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –Ω–æ–≤ SSH –∫–ª—é—á –∑–∞ —Å—ä—Ä–≤—ä—Ä–µ–Ω –ø—Å–µ–≤–¥–æ–Ω–∏–º '$server_alias'..."
  ssh-keygen -t ed25519 -f "$key_path" -C "$USER@${server_alias}" -N ""
  if [[ $? -eq 0 ]]; then
    echo "‚úÖ SSH –∫–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ —É—Å–ø–µ—à–Ω–æ —Å—ä–∑–¥–∞–¥–µ–Ω–∏:"
    echo "   - –ü—Ä–∏–≤–∞—Ç–µ–Ω –∫–ª—é—á: $key_path"
    echo "   - –ü—É–±–ª–∏—á–µ–Ω –∫–ª—é—á: ${key_path}.pub"
  else
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ—Ç–µ!"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ SSH –∫–ª—é—á. –©–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â (–∞–∫–æ –∏–º–∞):"
  echo "   - $key_path"
fi

echo ""
echo ""


echo "[8] –ö–ê–ß–í–ê–ù–ï –ù–ê –ü–£–ë–õ–ò–ß–ù–ò–Ø –ö–õ–Æ–ß –ù–ê –°–™–†–í–™–†–ê..."
echo "-------------------------------------------------------------------------"

read -rp "–í—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ –∑–∞ $host_ip: " ssh_user
read -rp "–í—ä–≤–µ–¥–µ—Ç–µ SSH –ø–æ—Ä—Ç –∑–∞ –≤—Ä—ä–∑–∫–∞ (–Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ Enter –∑–∞ 22): " ssh_port
ssh_port="${ssh_port:-22}"  # –∞–∫–æ –Ω—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω –ø–æ—Ä—Ç, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ 22

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ
if [[ ! -f "$key_path" || ! -f "$key_path.pub" ]]; then
  echo "‚ùå –ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ SSH –∫–ª—é—á–æ–≤–µ—Ç–µ –∑–∞ '$server_alias'. –û—á–∞–∫–≤–∞ —Å–µ: $key_path –∏ ${key_path}.pub"
  echo "   –ê–∫–æ –∏—Å–∫–∞—Ç–µ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç–µ –∫–ª—é—á–æ–≤–µ, —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∏–∑–±–µ—Ä–µ—Ç–µ 'y' –ø—Ä–∏ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ—Ç–æ."
  exit 1
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–ª—é—á—ä—Ç –≤–µ—á–µ –µ –∫–∞—á–µ–Ω..."
if ssh -p "$ssh_port" -o PasswordAuthentication=no -o IdentitiesOnly=yes -i "$key_path" "$ssh_user@$host_ip" true 2>/dev/null; then
  echo "‚úÖ –ö–ª—é—á—ä—Ç –≤–µ—á–µ –µ –∫–∞—á–µ–Ω –Ω–∞ $host_ip."
else
  echo "‚¨ÜÔ∏è –ö–∞—á–≤–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω–∏—è –∫–ª—é—á —á—Ä–µ–∑ ssh-copy-id..."
  echo "(–ú–æ–∂–µ –¥–∞ –±—ä–¥–µ—Ç–µ –ø–æ–¥–∫–∞–Ω–µ–Ω–∏ –¥–∞ –≤—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞)"

  if ! ssh-copy-id \
      -p "$ssh_port" \
      -i "$key_path.pub" \
      -o IdentitiesOnly=yes \
      -o IdentityFile="$key_path" \
      "$ssh_user@$host_ip"; then

    echo "‚ö†Ô∏è  –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ—Ç–æ. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä —Ö–æ—Å—Ç –∫–ª—é—á..."
    ssh-keygen -f "$HOME/.ssh/known_hosts" -R "$host_ip" >/dev/null 2>&1
    ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[$host_ip]:$ssh_port" >/dev/null 2>&1
    sed -i "/$host_ip/d" "$HOME/.ssh/known_hosts" || true

    echo "üîÑ –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∞–∫—Ç—É–∞–ª–Ω–∏—è —Ö–æ—Å—Ç –∫–ª—é—á –≤ known_hosts..."
    ssh-keyscan -p "$ssh_port" "$host_ip" >> "$HOME/.ssh/known_hosts" 2>/dev/null

    echo "üîÅ –ü–æ–≤—Ç–æ—Ä–µ–Ω –æ–ø–∏—Ç –∑–∞ –∫–∞—á–≤–∞–Ω–µ..."
    if ! ssh-copy-id \
        -p "$ssh_port" \
        -i "$key_path.pub" \
        -o StrictHostKeyChecking=no \
        -o IdentitiesOnly=yes \
        -o IdentityFile="$key_path" \
        "$ssh_user@$host_ip"; then

      echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∫–∞—á–≤–∞–Ω–µ –¥–æ—Ä–∏ —Å–ª–µ–¥ –ø–æ—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ known_hosts."
      exit 1
    fi
  fi
  echo "‚úÖ –ü—É–±–ª–∏—á–Ω–∏—è—Ç –∫–ª—é—á –µ –∫–∞—á–µ–Ω —É—Å–ø–µ—à–Ω–æ."
fi

echo ""
echo ""


###############################################################################
echo "[9] –ó–ê–ü–ò–° –í SSH CONFIG –§–ê–ô–õ–ê..."
echo "-------------------------------------------------------------------------"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∏–∑–±—Ä–∞ –¥–∞ –ø—Ä–µ–∑–∞–ø–∏—à–µ –∑–∞–ø–∏—Å–∞
if grep -qE "^Host $quick_connect\$" "$config_file" 2>/dev/null; then
  if [[ "$overwrite_config" == "true" ]]; then
    echo "üîÅ –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—è –∑–∞–ø–∏—Å –∑–∞ '$quick_connect'..."

    # –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏—è –∑–∞–ø–∏—Å
    awk -v alias="$quick_connect" '
      BEGIN {skip=0}
      $1=="Host" && $2==alias {skip=1; next}
      skip && $1=="Host" {skip=0}
      !skip {print}
    ' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"
  else
    echo "‚è≠Ô∏è  –ó–∞–ø–∏—Å—ä—Ç –≤ config —Ñ–∞–π–ª–∞ –±–µ—à–µ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç –ø–æ –∏–∑–±–æ—Ä –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    echo ""
    echo ""
    exit 0
  fi
fi

# –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∏—è –∑–∞–ø–∏—Å
{
  echo "Host $quick_connect"
  echo "    HostName $host_ip"
  echo "    User $ssh_user"
  echo "    Port $ssh_port"
  echo "    IdentityFile $key_path"
  echo "    IdentitiesOnly yes"
} >> "$config_file"

chmod 600 "$config_file"

echo "‚úÖ –ó–∞–ø–∏—Å—ä—Ç –∑–∞ '$quick_connect' –±–µ—à–µ –¥–æ–±–∞–≤–µ–Ω –≤ $config_file"
echo "üì° –í–µ—á–µ –º–æ–∂–µ—Ç–µ –¥–∞ —Å–µ —Å–≤—ä—Ä–∑–≤–∞—Ç–µ —Å—ä—Å: ssh $quick_connect"
echo ""
echo "‚ùì –ñ–µ–ª–∞–µ—Ç–µ –ª–∏ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—Ç–µ –¥—Ä—É–≥ SSH –∫–ª—é—á?"
echo "[y] - –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç–Ω–∞—á–∞–ª–æ"
echo "[n] - –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ—Ç–æ! –°–∫—Ä–∏–ø—Ç—ä—Ç —â–µ –±—ä–¥–µ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç."
echo ""

while true; do
  read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä (y/n): " choice
  case "$choice" in
    [Yy])
      echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞..."
      exec "$0"
      ;;
    [Nn])
      echo "üôè –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º, —á–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ö—Ç–µ ssh-server-key.sh!"
      echo "üßπ –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞..."
      if [[ -f "$0" ]]; then
        rm -- "$0" && echo "‚úÖ –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –∏–∑—Ç—Ä–∏—Ç —É—Å–ø–µ—à–Ω–æ."
      else
        echo "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç—ä—Ç –≤–µ—á–µ –µ –∏–∑—Ç—Ä–∏—Ç –∏–ª–∏ –ª–∏–ø—Å–≤–∞."
      fi
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ 'y' –∏–ª–∏ 'n'."
      ;;
  esac
done

echo ""
echo ""
# --------- –ö—Ä–∞–π –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ ---------
